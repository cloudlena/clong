<!DOCTYPE html>
<html lang="en">
<head>
    <title>Clong</title>

    <meta charset="UTF-8">
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="msapplication-tap-highlight" content="no" />

    <link rel="stylesheet" href="/assets/styles/styles.css">
</head>
<body>
    <div id="start-button">
        <button class="btn" onclick="startGame()">Start Game</button>
    </div>
    <p id="intro" style="display:none;text-align:center;">Swipe up to shoot balls at targets on big screen</p>
    <div id="main"></div>
    <div id="spinner"></div>
    <div class="hud">
        <div id="timer"><span id="sec-num">60</span> sec</div>
        <div id="score"><span id="score-num">0</span> points</div>
    </div>
    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"
        integrity="sha256-eVNjHw5UeU0jUqPPpZHAkU1z4U+QFBBY488WvueTm88="
        crossorigin="anonymous"></script>
    <script src="/assets/scripts/helpers.js"></script>
    <script>
    var ws = new WebSocket(wsProtocol() + '//' + window.location.host + '/ws/controller');
    var main = document.getElementById('main');
    var spinner = document.getElementById('spinner');
    var mc = new Hammer(main);

    // Initialize global variables
    var w = 0;
    var h = 0;
    var myID = '';
    var myColor = 'white';
    var gameRunning = false;
    var locked = false;
    var myPoints = 0;
    var myTime = 0;

    function init() {
        calcScreenSize();
        window.addEventListener('resize', function() {
            calcScreenSize();
        });

        // Init player
        myID = setUserID();
        setUserName();
        myColor = randomColor();
        main.style.backgroundColor = myColor;
        spinner.style.borderColor = myColor;
        spinner.style.borderTopColor = '#131313';

        // Listen for new swipes
        mc.get('swipe').set({ direction: Hammer.DIRECTION_ALL });
        mc.on('swipe', function(e) {
            if (gameRunning && !locked) {
                $('#intro').hide();

                var msg = {
                    type: 'ballInit',
                    color: myColor,
                    posX: relW(e.center.x),
                    velocityX: relW(e.velocityX),
                    velocityY: relH(e.velocityY),
                };
                ws.send(JSON.stringify(msg));

                lock();
            }
        });

        // Listen for when ball is done to unlock screen
        ws.addEventListener('message', function(e) {
            var msg = JSON.parse(e.data);
            if (gameRunning && msg.type === 'ballDone' && msg.player.id === myID) {
                myPoints += msg.points;
                $('#score-num').text(myPoints);
                unlock();
            }
        });
    }

    function startGame() {
        $('#start-button').hide();
        myTime = 60;
        $('#sec-num').text(myTime);
        myPoints = 0;
        $('#score-num').text(myPoints);
        $('#intro').show();
        gameRunning = true;
        var gameLoop = setInterval(function() {
            myTime--;
            $('#sec-num').text(myTime);
            if (myTime <= 0) {
                gameRunning = false;
                unlock();
                $('#start-button').show();
                clearInterval(gameLoop);
                msg = {
                    type: 'gameDone',
                    finalScore: myPoints,
                    color: myColor,
                };
                ws.send(JSON.stringify(msg));
            }
        }, 1000);
    }

    // Sets a cookie in the cookie jar
    function setCookie(name, value) {
        document.cookie = name + "=" + value;
    }

    // Gets a cookie from the cookie jar
    function getCookie(name) {
        var nameEQ = name + "=";
        var decodedCookie = decodeURIComponent(document.cookie);
        var ca = decodedCookie.split(';');

        for(var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) === ' ') { c = c.substring(1); }
            if (c.indexOf(nameEQ) === 0) { return c.substring(nameEQ.length, c.length); }
        }

        return null;
    }

    function setUserID() {
        var userid = getCookie('userid');

        if (userid === null) {
            userid = uuid();
            setCookie('userid', userid);
        }

        return userid;
    }

    function getUserName() {
        var userName = prompt('Please enter your first and last name (2-30 characters)', '');

        if (userName === null || userName.length < 2 || userName.length > 30) {
            userName = getUserName()
        }

        return userName;
    }

    function setUserName() {
        var userName = getCookie('username');

        if (userName === null) {
            userName = getUserName();
            setCookie('username', userName);
        }

        return userName;
    }

    function lock() {
        locked = true;
        main.style.display = 'none';
    }

    function unlock() {
        locked = false;
        main.style.display = 'block';
    }

    if (window.WebSocket) {
        init();
    } else {
        $('#start-button .btn').hide();
        $('.hud').hide();
        $('#start-button').append('<p style="text-align:center;margin-top:2em;">Sorry, your browser isn\'t supported...</p>');
    }
    </script>
</body>
