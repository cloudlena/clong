<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    <title>Clong Screen</title>

    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <canvas id="clong-canvas"></canvas>

    <script>
    var wsProtocol = 'ws';
    if (window.location.protocol === "https:") {
        wsProtocol = 'wss';
    }
    var ws = new WebSocket(wsProtocol + '://' + window.location.host + '/ws/screen');

    var balls = [];
    var targets = [];

    var w = 0;
    var h = 0;

    function init() {
        ws.addEventListener('message', function(e) {
            var msg = JSON.parse(e.data);
            balls.push(msg);
        });

        targets = [
            {
                imgUrl: 'https://cdn.worldvectorlogo.com/logos/react.svg',
                posX: 10,
                posY: 90,
                velocityX: 0.4,
                velocityY: 0,
                width: 6,
                height: 6,
            },
        ];
        for (i = 0; i < targets.length; i++) {
            targets[i].img = new Image();
            targets[i].img.src = targets[i].imgUrl;
        }

        window.requestAnimationFrame(draw);
    }

    function abs(percentage) {
        return Math.max(w, h) * (percentage/100);
    }
    function absH(percentage) {
        return h * (percentage/100);
    }
    function absW(percentage) {
        return w * (percentage/100);
    }

    function dist(a, b) {
        var dX = a.posX - b.posX;
        var dY = a.posY - b.posY;
        return Math.sqrt( dX*dX + dY*dY );
    }

    function draw() {
        var canvas = document.getElementById("clong-canvas");
        var ctx = canvas.getContext("2d");

        w = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
        h = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);

        ctx.canvas.width = w;
        ctx.canvas.height = h;

        ctx.globalCompositeOperation = 'destination-over';
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); // clear canvas

        for (i = 0; i < targets.length; i++) {
            var t = targets[i];

            ctx.drawImage(t.img, absW(t.posX), absH(100-t.posY), abs(t.width), abs(t.height));

            if (t.posX < 2 || t.posX > (98-(t.width))) {
                targets[i].velocityX = -t.velocityX;
            }

            targets[i].posX += t.velocityX;
            targets[i].posY += t.velocityY;

            for (j = 0; j < balls.length; j++) {
                var b = balls[j];
                if (dist(b, t) < (t.width/2)+1) {
                    targets.splice(i, 1);
                }
            }
        }

        for (i = 0; i < balls.length; i++) {
            var b = balls[i];
            ctx.fillStyle = b.color;
            ctx.beginPath();
            ctx.arc(absW(b.posX), absH(100-b.posY), abs(1.5), 0, 2*Math.PI);
            ctx.fill();

            balls[i].posX += b.velocityX;
            balls[i].posY += b.velocityY;

            if (balls[i].posY > 110) {
                balls.splice(i, 1);
            }
        }

        window.requestAnimationFrame(draw);
    }

    init();
    </script>
</body>
