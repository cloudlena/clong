<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Clong Screen</title>

    <link rel="stylesheet" href="/assets/styles/styles.css">
</head>
<body>
    <canvas id="clong-canvas"></canvas>

    <script src="/assets/scripts/helpers.js"></script>
    <script>
    var ws = new WebSocket(wsProtocol() + '//' + window.location.host + '/ws/screen');

    // Set game settings
    var ballRadius = 1;
    var maxTargets = 5;
    var targetSpawnIntervalMin = 2000;
    var targetSpawnIntervalMax = 3000;
    var targetTypes = [
        {
            imgUrl: 'https://api.lyra-836.appcloud.swisscom.com/static-media/images/service/atmos.svg',
            sizeRatio: 1,
        },
        {
            imgUrl: 'https://api.lyra-836.appcloud.swisscom.com/static-media/images/service/elk.svg',
            sizeRatio: 1,
        },
        {
            imgUrl: 'https://api.lyra-836.appcloud.swisscom.com/static-media/images/service/redis.svg',
            sizeRatio: 1,
        },
        {
            imgUrl: 'https://api.lyra-836.appcloud.swisscom.com/static-media/images/service/rabbitmq.svg',
            sizeRatio: 1,
        },
        {
            imgUrl: 'https://api.lyra-836.appcloud.swisscom.com/static-media/images/service/mariadb.svg',
            sizeRatio: 1,
        },
        {
            imgUrl: 'https://api.lyra-836.appcloud.swisscom.com/static-media/images/service/mongodb.svg',
            sizeRatio: 1,
        },
    ];

    // Initialize global variables
    var w = 0;
    var h = 0;
    var balls = [];
    var targets = [];

    function init() {
        calcScreenSize();
        window.addEventListener('resize', function() {
            calcScreenSize();
        });

        // Initialize target images
        for (i = 0; i < targetTypes.length; i++) {
            targetTypes[i].img = new Image();
            targetTypes[i].img.src = targetTypes[i].imgUrl;
        }

        // Listen for new balls coming in
        ws.addEventListener('message', function(e) {
            var msg = JSON.parse(e.data);
            if (msg.msgType === 'ballInit') {
                if (msg.velocityY > 0) {
                    msg.radius = ballRadius;
                    msg.velocityY = Math.max(msg.velocityY, 0.05) * 1.5;

                    balls.push(msg);
                } else {
                    ballDone(msg.player, 0);
                }
            }
        });

        // Trigger forever loops
        spawnTarget(randInt(targetSpawnIntervalMin, targetSpawnIntervalMax));
        window.requestAnimationFrame(draw);
    }

    function ballDone(player, points) {
        var msg = {
            msgType: 'ballDone',
            player: player,
            points: points,
        };
        ws.send(JSON.stringify(msg));
    }

    // Regularly spawn new targets
    function spawnTarget(ms) {
        setTimeout(function() {
            if (targets.length < maxTargets) {
                var type = targetTypes[randInt(0, targetTypes.length)];
                var width = randInt(2, 13);
                var height = width * type.sizeRatio * (w/h);

                targets.push({
                    img: type.img,
                    posX: randInt(20, 80),
                    posY: randInt(height, 100),
                    velocityX: Math.random() - 0.5,
                    velocityY: 0,
                    width: width,
                    height: height,
                });
            }

            spawnTarget(randInt(targetSpawnIntervalMin, targetSpawnIntervalMax));
        }, ms);
    }

    // Draw current status onto canvas
    function draw() {
        var canvas = document.getElementById("clong-canvas");
        var ctx = canvas.getContext("2d");

        ctx.canvas.width = w;
        ctx.canvas.height = h;

        // Clear canvas
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

        // Draw balls
        for (i = 0; i < balls.length; i++) {
            var b = balls[i];

            ctx.fillStyle = b.color;
            ctx.beginPath();
            ctx.arc(absW(b.posX), absH(100 - b.posY), absW(b.radius), 0, 2 * Math.PI);
            ctx.fill();

            balls[i].posX += b.velocityX;
            balls[i].posY += b.velocityY;

            if (b.posY >= 100 || b.posX <= 0 || b.posX >= 100) {
                ballDone(b.player, 0);
                balls.splice(i, 1);
            }
        }

        // Draw targets
        for (i = 0; i < targets.length; i++) {
            var t = targets[i];

            ctx.drawImage(t.img, absW(t.posX), absH(100 - t.posY), absW(t.width), absH(t.height));

            // Invert velocity if target reaches end of screen
            if (t.posX <= 0 || t.posX >= (100 - (t.width))) {
                targets[i].velocityX = -t.velocityX;
            }

            targets[i].posX += t.velocityX;
            targets[i].posY += t.velocityY;

            for (j = 0; j < balls.length; j++) {
                var b = balls[j];
                if (doCollide(t, b)) {
                    var points = calcPoints(t.posY, t.width, t.height, t.velocityX);
                    ballDone(b.player, points);
                    targets.splice(i, 1);
                    balls.splice(j, 1);
                }
            }
        }

        window.requestAnimationFrame(draw);
    }

    init();
    </script>
</body>
